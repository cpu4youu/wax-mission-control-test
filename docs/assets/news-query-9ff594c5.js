import{g as m,S as g,T as y,c as F,d as T,Q as A}from"./index-0958298f.js";import{A as b}from"./axios-45629df5.js";import{s as N}from"./sleep-da79c358.js";const x=async()=>await m({options:{code:g.MISSION_CONTROL,index_position:1,limit:"10000",scope:g.MISSION_CONTROL,table:y.BLOGS}}),d={label:"All",value:"all"},w=F((e,r)=>({newsFilters:[d],updateNewsFilters:a=>v(e,a),newsFiltersSelected:d,updateNewsFiltersSelected:a=>O(e,a)}));function v(e,r){e(a=>({...a,newsFilters:[d,...r]}))}function O(e,r){e(a=>({...a,newsFiltersSelected:r}))}function C(e,r,a){const o={value:r,expiry:new Date().getTime()+a};localStorage.setItem(e,encodeURIComponent(JSON.stringify(o)))}function I(e){const r=localStorage.getItem(e);if(!r)return null;try{const a=JSON.parse(decodeURIComponent(r));return new Date().getTime()>a.expiry?(localStorage.removeItem(e),null):a.value}catch{return localStorage.removeItem(e),null}}const P=e=>T({queryKey:[A.NEWS],queryFn:()=>_(e),staleTime:1e3*60*60});async function _(e){const r=I("@awq_news_cookies");if(r&&e)return{newsOnHome:r};try{const a=await x();if(!a)return null;const t=D(a),o=q(t),l=w.getState().updateNewsFilters;l(o);const n=await R(t),s="@awq_news_cookies",u=n==null?void 0:n.newsOnHome,i=1e3*60*60*4;return C(s,u,i),n}catch(a){return console.log(a),null}}function q(e){return e.map(r=>{if(r.blogid==="mining-matters"){const a=w.getState().updateNewsFiltersSelected;a({label:r.blogname,value:r.blogid})}return{label:r.blogname,value:r.blogid}})}function D(e){const r=e.map(a=>({...a,url:`https%3A%2F%2Fmedium.com%2Ffeed%2F${a.blogid}`}));return[...r,{id:r[r.length-1].id+1,blogid:"alien-articles",blogname:"Alienw.com",url:"https%3A%2F%2Falienw.com%2Ffeed"}]}async function R(e){const r=await U(e),a=r.reduce((o,l)=>{var n;return((n=l==null?void 0:l.loadedArticles)==null?void 0:n.length)>0&&o.push(l.loadedArticles),o},[]).flat().sort((o,l)=>new Date(o.published).getTime()>new Date(l.published).getTime()?-1:1),t=a.reduce((o,l)=>(o.find(s=>s.author===l.author)||o.push(l),o),[]);return{all:a,newsOnHome:t,...r.reduce((o,l)=>{var n;return o[l.blogid]=(n=l==null?void 0:l.loadedArticles)==null?void 0:n.sort((s,u)=>new Date(s.published).getTime()>new Date(u.published).getTime()?-1:1),o},{})}}const p=["https://api.rss2json.com/v1/api.json?rss_url=","https://rss-to-json-serverless-api.vercel.app/api?feedURL=","https://api.apyhub.com/convert/rss-url/json"];async function U(e){const r=[];for(const a of e){let t=0,o=!1,l=0;do{try{if(p[t]==="https://api.apyhub.com/convert/rss-url/json"){const n={method:"POST",url:"https://api.apyhub.com/convert/rss-url/json",params:{detailed:"true"},headers:{"apy-token":"APY0RZnFoIUDElOH2WDX0UTaoNLdIXvSVWsUV5vjr0hnzu94p2eV0S32khkFBrO53pz4vjBVWoWdsA","Content-Type":"application/json"},data:{url:decodeURIComponent(a.url)}},{data:s}=await b.request(n),u=S(s,p[t]);r.push({...a,loadedArticles:u})}else{const{data:n}=await b(`${p[t]}${a.url}`),s=S(n,p[t]);r.push({...a,loadedArticles:s})}o=!1}catch{o=!0,t++,t===p.length&&(l++,t=0),l===3&&(o=!1)}await N(1e3)}while(o)}return r}function S(e,r){var a;return r==="https://api.apyhub.com/convert/rss-url/json"?e==null?void 0:e.items.map(t=>{var u,i,c;const l=new DOMParser().parseFromString(t.content_html,"text/html"),n=l.querySelector("p"),s=l.querySelector("img");return!n||!n.textContent?{...t,description:"",thumbnail:s==null?void 0:s.getAttribute("src")}:{title:t.title.replace(/&amp;/g,"&"),link:t.url,author:(t==null?void 0:t.authors[0].name)??((u=e==null?void 0:e.feed)==null?void 0:u.title),published:t.date_published,description:n.textContent,thumbnail:(s==null?void 0:s.getAttribute("src"))??((i=t==null?void 0:t.enclosure)==null?void 0:i.thumbnail)??((c=e==null?void 0:e.feed)==null?void 0:c.image)}}):r==="https://api.rss2json.com/v1/api.json?rss_url="?e==null?void 0:e.items.map(t=>{var u,i,c;const l=new DOMParser().parseFromString(t.content,"text/html"),n=l.querySelector("p"),s=l.querySelector("img");return{title:t.title.replace(/&amp;/g,"&"),link:t.link,author:(t==null?void 0:t.author)??((u=e==null?void 0:e.feed)==null?void 0:u.title),published:t.pubDate,description:(n==null?void 0:n.textContent)||"",thumbnail:(s==null?void 0:s.getAttribute("src"))??((i=t==null?void 0:t.enclosure)==null?void 0:i.thumbnail)??((c=e==null?void 0:e.feed)==null?void 0:c.image)}}):r==="https://rss-to-json-mc.vercel.app/api?url="?(a=e==null?void 0:e.data)==null?void 0:a.items.map(t=>{var u,i,c,h,f;const l=new DOMParser().parseFromString(t.content,"text/html"),n=l.querySelector("p"),s=l.querySelector("img");return{title:t.title.replace(/&amp;/g,"&"),link:t.link,author:(t==null?void 0:t.author)??((i=(u=e==null?void 0:e.data)==null?void 0:u.feed)==null?void 0:i.title),published:t.published,description:(n==null?void 0:n.textContent)||"",thumbnail:(s==null?void 0:s.getAttribute("src"))??((c=t==null?void 0:t.enclosure)==null?void 0:c.thumbnail)??((f=(h=e==null?void 0:e.data)==null?void 0:h.feed)==null?void 0:f.image)}}):e==null?void 0:e.items.map(t=>{var u,i;const l=new DOMParser().parseFromString(t.content,"text/html"),n=l.querySelector("p"),s=l.querySelector("img");return!n||!n.textContent?{...t,description:"",thumbnail:s==null?void 0:s.getAttribute("src")}:{link:t.link,title:t.title.replace(/&amp;/g,"&"),author:(t==null?void 0:t.author)??(e==null?void 0:e.title),description:n.textContent,thumbnail:(s==null?void 0:s.getAttribute("src"))||((i=(u=t==null?void 0:t.media)==null?void 0:u.thumbnail)==null?void 0:i.url)||(e==null?void 0:e.image),published:t.published}})}export{w as a,P as u};
