import{s as d,e as se,aC as ce,V as de,W as oe,aD as ue,b as L,X as S,R as o,f as C,a1 as fe,a2 as D,d as E,aw as F,aE as P,n as I,j as t,p as u,B as Q,av as pe,a8 as me,h as H,U as xe,aF as we,$ as ge,a0 as he,aG as le,az as ye,aH as Me,aI as _e,aJ as je,aK as Te,q as be,Q as ve,ak as Le}from"./index-6b7758a9.js";import{C as Se}from"./index-428fad6a.js";import{P as Ce}from"./pickaxe-e11dcde6.js";import{a as De,f as Ee,e as Ie,o as Be,d as $e,g as ke,h as Re}from"./format-date-to-iso-fbe613e6.js";import{i as B}from"./index-65c3670c.js";const Ne=d("div",{d:"flex",align:"flex-start",justify:"center",direction:"column",mt:"35px",w:"100%"}),Ae=d("h2",{d:"flex",align:"center",justify:"center",fs:"20px",color:"$white500"}),Oe=d("div",{d:"flex",align:"center",justify:"flex-start",direction:"column",mb:"15px",w:"100%",color:"$white500",ff:"$heading","@sm":{flexWrap:"wrap"}}),Ve=d("div",{d:"flex",align:"center",justify:"flex-start",gap:"5px",w:"100%",color:"$white500",ff:"$heading","@sm":{flexWrap:"wrap"}}),Fe=d("div",{d:"flex",align:"center",justify:"flex-start",gap:"5px",w:"100%",color:"$white500",ff:"$heading",button:{w:"100%",minH:"30px",minW:"unset",maxW:"140px",">div":{minH:"30px",border:"none"}},"@sm":{flexWrap:"wrap"}}),G=d("span",{ff:"$heading",fw:"$bold",fs:"20px",variants:{color:{red:{color:"#E52251"},green:{color:"#00FF00"}}},"@sm":{fs:"16px"}}),Pe=d("div",{d:"flex",align:"center",justify:"flex-start",flexWrap:"wrap",gap:"25px",mt:"15px",w:"100%","@sm":{justify:"center"}}),Qe=d("div",{d:"flex",align:"center",justify:"center",direction:"column",gap:"5px",mt:"auto",w:"100%",button:{w:"100%",minH:"40px",minW:"unset",maxW:"90%",">div":{border:"none"}}}),He=d("div",{d:"flex",align:"center",justify:"center",m:"5px 0 10px",w:"100%"}),U=d("div",{d:"flex",align:"center",justify:"center",gap:"10px",w:"100%",svg:{filter:"drop-shadow(3px 5px 2px rgb(0 0 0 / 0.6))",w:"20px",h:"20px"}}),q=d("p",{d:"flex",align:"center",justify:"center",color:"$white500",textShadow:"2px 1px 4px rgba(0, 0, 0)",fs:"14px",ff:"$heading",fw:"400"}),Ge=se({"0%":{backgroundPosition:"0% 0%"},"100%":{backgroundPosition:"-135% 0%"}}),Ue=d("div",{width:"174px",height:"259px",background:"linear-gradient( -90deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.25) ,rgba(255, 255, 255, 0.15))",br:"10px",backgroundSize:"400% 400%",animation:`${Ge} 1.2s ease-in-out infinite`,"@sm":{width:"70px",height:"100px"}}),qe=[{label:"Sort by rarity",value:"rarity"}],We=()=>{const{data:n}=ce(),{data:m}=de(),{data:x}=oe(),{data:p,isLoading:z}=ue(),{data:s}=De(),i=L(e=>e.user),K=L(e=>e.updateMember),$=S(e=>e.isCalculating),Y=S(e=>e.updateIsCalculating),k=S(e=>e.updateMineButtonLoading),[R,J]=o.useState([]),[h,X]=o.useState([]),[M,_]=o.useState(!1),[N]=o.useState(qe[0]),[,T]=o.useState(!1),[Z,W]=o.useState("");async function ee(e){try{const a=await Promise.all(ye.map(async w=>{const y=await Me(w);return{title:w,img:`/assets/planets/${w}.png`,data:(y==null?void 0:y.pool_buckets.map(g=>({...g,value_formatted:u(g==null?void 0:g.value)??0})))??[]}})),r=_e(a),c=await je(r,"red",e),f=Te(c);return be.setQueriesData([ve.LANDS,"red",e],{list:c,highestValue:f}),{list:c,highestValue:f}}catch(a){console.log(a);return}}async function ae(e){var a,r,c;if(i){_(!0),k(!0);try{await me(),Y(!0),await H(500);const f=await ee(e);if(!((a=f==null?void 0:f.highestValue)!=null&&a.asset_id))throw new Error("No land found");const w=(r=f.highestValue)==null?void 0:r.asset_id,y=(m==null?void 0:m.current_land)===w?void 0:w,{getAssetByAssetId:g}=xe,ie=await g(String(e.next_asset_id)),V=x==null?void 0:x.allData.find(v=>v.template_id===Number(ie.template.template_id));if(!V)return;await we({user:i,next_tool:[V],assets_ids:[e.next_asset_id],land_asset_id:y,old_bag_assets_ids:((c=x==null?void 0:x.userTools)==null?void 0:c.map(v=>Number(v.asset_id)))??[]})&&(await ge(i==null?void 0:i.name),await he(),await le())}catch(f){console.error("Error on MINE tool",f)}finally{k(!1),_(!1)}}}const j=C.useCallback(e=>{const a=e.cooldown_seconds*1.6;return fe(a,{userTools:[e],allData:[]},m)},[m]),b=C.useCallback(e=>D(E(j(e))),[j]),A=C.useCallback(async()=>{if(!(p!=null&&p.toolsOv))return[];const e=await Promise.all(p==null?void 0:p.toolsOv.filter(a=>{var r;return((n==null?void 0:n.tempid_allow_list.length)??0)===0?a.owned>0&&a.allowed===1:a.owned>0&&a.allowed===1&&((r=n==null?void 0:n.tempid_allow_list)==null?void 0:r.some(c=>c===a.template_id))}).map(async a=>{const r=p.stakedTools.find(c=>c.template_id===a.template_id);return{...a,...r,last_use:+new Date(`${a.readyat}.000Z`)/1e3-a.cooldown_seconds}}));J(e)},[p]);o.useEffect(()=>{A()},[A]),o.useEffect(()=>{if(N.value==="rarity"){const e=R.sort((a,r)=>F[a.rarity]-F[r.rarity]||P[a.shine]-P[r.shine]);X(e)}},[R,N.value]),o.useEffect(()=>{const e=setInterval(()=>{h.every(a=>D(E(j(a)))==="MINE")?(T(a=>!a),clearInterval(e)):T(a=>!a)},1e3);return T(a=>!a),()=>clearInterval(e)},[h,m,j]);const O=e=>{if(u(e==null?void 0:e.deposit)===0&&u(e==null?void 0:e.trialtlm)>0)return"red";if(u(e==null?void 0:e.deposit)>=0)return"green"},te=e=>{if(u(e==null?void 0:e.deposit)===0&&u(e==null?void 0:e.trialtlm)>0)return`- ${u(e==null?void 0:e.trialtlm)}`;if(u(e==null?void 0:e.deposit)>=0)return u(e==null?void 0:e.deposit)};async function ne(){if(!(i!=null&&i.name))return null;await H(500);const e=await Le(i==null?void 0:i.name);L.setState(a=>({...a,user:a.user?{...a.user,userTlm:e}:null})),await K(),await Be(),await $e(),await ke(),await Re()}const l=o.useMemo(()=>new Date((s==null?void 0:s.timestamp)||new Date),[s==null?void 0:s.timestamp]);async function re(){if(i){_(!0);try{if(!await Ie(i))throw new Error("Claim Mines error from contract");await ne()}catch(e){console.log(e)}finally{_(!1)}}}return o.useEffect(()=>{const e=setInterval(()=>{const a=new Date(`${Ee(l)}`),r=E(a),c=D(r);if(W(c),!B(I,l)){clearInterval(e);return}},1e3);return()=>clearInterval(e)},[l]),t.jsxs(Ne,{children:[t.jsx(Ae,{children:"LOAN TOOLS"}),t.jsxs(Oe,{children:[t.jsxs(Ve,{children:["Deposited TLM:"," ",t.jsxs(G,{color:O(n),children:[te(n)," TLM"," ",u(n==null?void 0:n.deposit)<0&&u(n==null?void 0:n.trialtlm)>0&&"(Deposit more TLM)"]})]}),t.jsxs(Fe,{children:["AW Mining Rewards:"," ",t.jsxs(G,{color:O(n),children:[(s==null?void 0:s.amount.replace(" TLM",""))??"0.0000"," TLM"]}),t.jsx(Q,{isLoading:M,disabled:M||((s==null?void 0:s.amount)??0)===0||B(I,l),onClick:re,rounded:!1,color:"solidBlue",noBorder:!0,children:B(I,l)?Z:"Claim"})]})]}),t.jsx(Pe,{children:z?new Array(6).fill(0).map((e,a)=>t.jsx(Ue,{},a)):h==null?void 0:h.map((e,a)=>t.jsx(Se,{showNumberBracket:!0,tool:e,children:t.jsxs(Qe,{children:[t.jsx(Q,{isLoading:M||$,disabled:M||$||b(e)!=="MINE",onClick:()=>ae(e),rounded:!1,color:"solidBlue",children:b(e)==="MINE"?"Mine":b(e)}),t.jsxs(He,{children:[t.jsxs(U,{children:[t.jsx(Ce,{}),t.jsx(q,{children:e.mining_power/10})]}),t.jsxs(U,{children:[t.jsx(pe,{}),t.jsx(q,{children:e.pow})]})]})]})},a))})]})};export{We as default};
